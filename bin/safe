#!/bin/bash

echo -e "\003[1mStarting the clock safely.\033[0m"

# Stopping if it is running.
if [ -s tmp/pids/unicorn.pid ]; then
	kill -INT `cat tmp/pids/unicorn.pid`
	echo -e "\033[1mThe clock is restarting.\033[0m"
else
	echo -e "\033[1mThe clock is starting.\033[0m"
fi

# Reset the logs.
rm log/*
mkdir -p tmp/pids log

# Re-Bundle dependencies.
echo -e "\033[1mRunning the Bundler install to get the dependencies.\033[0m"
bundle install --without development

# Run the tests.
echo -e "\033[1mRunning the tests.\033[0m"
bundle exec padrino rake spec

# Attempt at starting.
echo -e "\033[1mAttempting to start the server.\033[0m"
bundle exec unicorn -c config/unicorn.rb -E production -p 3000 -D

# Give an indication.
if [ -e tmp/pids/unicorn.pid ]; then
	echo -e "\033[1mThe clock has successfully started.\033[0m"
	exit 0
else
	echo -e "\033[1mSomething went wrong and the clock did not start.\033[0m"
	exit 1
fi

